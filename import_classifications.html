<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç±»æ•°æ®å¯¼å…¥ - Tweet Classification Import</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --border-color: #30363d;
            --accent-color: #7c3aed;
            --success-color: #3fb950;
            --error-color: #ff7b72;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 24px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .input-group {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .input-group label {
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .btn-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 12px;
        }

        button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.85;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
        }

        #status {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .result-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            display: none;
        }

        .result-box.show {
            display: block;
        }

        .result-box.success {
            border-color: var(--success-color);
        }

        .result-box.error {
            border-color: var(--error-color);
        }

        .result-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .result-box.success .result-title {
            color: var(--success-color);
        }

        .result-box.error .result-title {
            color: var(--error-color);
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font-size: 13px;
        }

        .preview-table th,
        .preview-table td {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        .preview-table th {
            background: var(--bg-primary);
            font-weight: 600;
        }

        .preview-table td {
            background: var(--bg-secondary);
        }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            margin: 2px;
            background: rgba(139, 92, 246, 0.15);
            color: #a78bfa;
            border-radius: 4px;
            font-size: 11px;
        }

        .tag.category {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .example {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 11px;
            font-family: 'Monaco', 'Menlo', monospace;
            color: var(--text-secondary);
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ“¥ åˆ†ç±»æ•°æ®å¯¼å…¥</h1>
        <p class="subtitle">æ‰¹é‡å¯¼å…¥ AI ç”Ÿæˆçš„åˆ†ç±»æ ‡ç­¾åˆ°æ•°æ®åº“</p>

        <div class="input-group">
            <div class="result-title">ğŸ“¤ å¾…å¤„ç†æ•°æ®å¯¼å‡º (For Grok)</div>
            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:12px;">è·å–å°šæœªåˆ†ç±»çš„æ¨æ–‡é“¾æ¥ï¼Œä»¥ä¾¿å‘é€ç»™ Grok è¿›è¡Œæ‰¹é‡åˆ†æã€‚
            </p>
            <div class="btn-row" style="margin-top:0">
                <input type="number" id="limitInput" value="20" min="1" max="100"
                    style="width:80px; padding:8px; border-radius:6px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary);">
                <button id="fetchUnclassifiedBtn">ğŸ” è·å–å¾…åˆ†ç±»é“¾æ¥</button>
            </div>
            <textarea id="unclassifiedOutput" placeholder="ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–é“¾æ¥..."
                style="min-height:100px; margin-top:12px; margin-bottom:12px;" readonly></textarea>
            <div class="btn-row" style="margin-top:0">
                <button id="copyLinksBtn" class="btn-secondary">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
            </div>
        </div>

        <div class="input-group">
            <label>ç²˜è´´ JSON æ•°æ®</label>
            <textarea id="jsonInput" placeholder='ç²˜è´´ Grok ç”Ÿæˆçš„ JSON æ•°ç»„ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
[
  {
    "post_id": "2010497572704501766",
    "author": "dotey",
    "hierarchical": {
      "è‰ºæœ¯ä¸å¹»æƒ³": ["ä¿¡æ¯å›¾/Infographic", "å¡é€š/æ’å›¾"]
    },
    "flat_tags": ["å°çº¢ä¹¦é£æ ¼", "infographic series"]
  },
  ...
]'></textarea>

            <div class="btn-row">
                <button id="validateBtn">ğŸ“‹ éªŒè¯æ ¼å¼</button>
                <button id="importBtn" disabled>ğŸ“¥ å¯¼å…¥æ•°æ®åº“</button>
                <button id="clearBtn" class="btn-secondary">æ¸…ç©º</button>
                <span id="status"></span>
            </div>
        </div>

        <div id="previewBox" class="result-box">
            <div class="result-title">ğŸ“‹ æ•°æ®é¢„è§ˆ</div>
            <div id="previewContent"></div>
        </div>

        <div id="resultBox" class="result-box">
            <div class="result-title" id="resultTitle">ç»“æœ</div>
            <div id="resultContent"></div>
        </div>

        <div class="input-group">
            <label>ğŸ“ ç¤ºä¾‹æ•°æ®æ ¼å¼</label>
            <div class="example">[
                {
                "post_id": "2010497572704501766",
                "author": "dotey",
                "hierarchical": {
                "è‰ºæœ¯ä¸å¹»æƒ³": ["ä¿¡æ¯å›¾/Infographic", "å¡é€š/æ’å›¾"],
                "äº§å“ä¸è¥é”€": ["å°çº¢ä¹¦é£æ ¼"]
                },
                "flat_tags": ["å°çº¢ä¹¦é£æ ¼", "infographic series", "AI prompt", "hand-drawn text"]
                }
                ]</div>
        </div>
    </div>

    <script>
        const jsonInput = document.getElementById('jsonInput');
        const validateBtn = document.getElementById('validateBtn');
        const importBtn = document.getElementById('importBtn');
        const clearBtn = document.getElementById('clearBtn');
        const status = document.getElementById('status');
        const previewBox = document.getElementById('previewBox');
        const previewContent = document.getElementById('previewContent');
        const resultBox = document.getElementById('resultBox');
        const resultTitle = document.getElementById('resultTitle');
        const resultContent = document.getElementById('resultContent');

        let parsedData = null;

        // Find API base
        let apiBase = window.location.origin;
        if (window.location.protocol === 'file:') {
            apiBase = 'http://localhost:5502';
        }

        validateBtn.addEventListener('click', () => {
            const input = jsonInput.value.trim();
            if (!input) {
                showResult('error', 'è¯·å…ˆç²˜è´´ JSON æ•°æ®');
                return;
            }

            try {
                parsedData = JSON.parse(input);

                if (!Array.isArray(parsedData)) {
                    throw new Error('æ•°æ®å¿…é¡»æ˜¯ JSON æ•°ç»„');
                }

                if (parsedData.length === 0) {
                    throw new Error('æ•°ç»„ä¸èƒ½ä¸ºç©º');
                }

                // Validate structure
                const errors = [];
                parsedData.forEach((item, i) => {
                    if (!item.post_id) {
                        errors.push(`ç¬¬ ${i + 1} é¡¹ç¼ºå°‘ post_id`);
                    }
                    if (!item.hierarchical || typeof item.hierarchical !== 'object') {
                        errors.push(`ç¬¬ ${i + 1} é¡¹çš„ hierarchical æ ¼å¼ä¸æ­£ç¡®`);
                    }
                });

                if (errors.length > 0) {
                    throw new Error(errors.join('\n'));
                }

                // Calculate Stats
                const totalItems = parsedData.length;
                const totalTags = parsedData.reduce((acc, item) => acc + (item.flat_tags ? item.flat_tags.length : 0), 0);
                const avgTags = totalItems > 0 ? (totalTags / totalItems).toFixed(1) : 0;

                // Show preview
                showPreview(parsedData);
                importBtn.disabled = false;
                status.innerHTML = `âœ“ éªŒè¯é€šè¿‡<br>
                    <span style="color:#8b949e; font-size:12px">
                    å…± ${totalItems} æ¡è®°å½• | 
                    æ ‡ç­¾æ€»æ•°: <strong style="color:#a78bfa">${totalTags}</strong> | 
                    å¹³å‡: <strong style="color:#a78bfa">${avgTags}</strong> ä¸ª/æ¡
                    </span>`;
                status.style.color = '#3fb950';

            } catch (e) {
                parsedData = null;
                importBtn.disabled = true;
                previewBox.classList.remove('show');
                showResult('error', `æ ¼å¼é”™è¯¯: ${e.message}`);
            }
        });

        importBtn.addEventListener('click', async () => {
            if (!parsedData) {
                showResult('error', 'è¯·å…ˆéªŒè¯æ•°æ®');
                return;
            }

            importBtn.disabled = true;
            status.textContent = 'å¯¼å…¥ä¸­...';

            try {
                const response = await fetch(`${apiBase}/api/import_classifications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(parsedData)
                });

                const result = await response.json();

                if (result.ok) {
                    showResult('success', `æˆåŠŸå¯¼å…¥ ${result.updated} æ¡è®°å½•`);
                    status.textContent = 'âœ“ å¯¼å…¥å®Œæˆ';
                    status.style.color = '#3fb950';
                } else {
                    throw new Error(result.error || 'å¯¼å…¥å¤±è´¥');
                }
            } catch (e) {
                showResult('error', `å¯¼å…¥å¤±è´¥: ${e.message}`);
                status.textContent = '';
            } finally {
                importBtn.disabled = false;
            }
        });

        clearBtn.addEventListener('click', () => {
            jsonInput.value = '';
            parsedData = null;
            importBtn.disabled = true;
            previewBox.classList.remove('show');
            resultBox.classList.remove('show');
            status.textContent = '';
        });

        function showPreview(data) {
            let html = `<table class="preview-table">
                <tr>
                    <th>Post ID</th>
                    <th>Author</th>
                    <th>åˆ†ç±» (hierarchical)</th>
                    <th>æ ‡ç­¾ (flat_tags)</th>
                </tr>`;

            data.slice(0, 10).forEach(item => {
                const categories = Object.entries(item.hierarchical || {}).map(([cat, subs]) =>
                    `<span class="tag category">${cat}</span>` +
                    (subs || []).map(s => `<span class="tag">${s}</span>`).join('')
                ).join('');

                const tags = (item.flat_tags || []).slice(0, 5).map(t =>
                    `<span class="tag">${t}</span>`
                ).join('');

                html += `<tr>
                    <td>${item.post_id}</td>
                    <td>${item.author || '-'}</td>
                    <td>${categories}</td>
                    <td>${tags}${(item.flat_tags || []).length > 5 ? '...' : ''}</td>
                </tr>`;
            });

            if (data.length > 10) {
                html += `<tr><td colspan="4" style="text-align:center; color:var(--text-secondary);">
                    ... è¿˜æœ‰ ${data.length - 10} æ¡è®°å½•
                </td></tr>`;
            }

            html += '</table>';
            previewContent.innerHTML = html;
            previewBox.classList.add('show');
        }

        function showResult(type, message) {
            resultBox.className = `result-box show ${type}`;
            resultTitle.textContent = type === 'success' ? 'âœ“ æˆåŠŸ' : 'âœ— é”™è¯¯';
            resultContent.textContent = message;
        }

        // Auto-validate on paste
        jsonInput.addEventListener('paste', () => {
            setTimeout(() => validateBtn.click(), 100);
        });

        // Export Logic
        const limitInput = document.getElementById('limitInput');
        const fetchUnclassifiedBtn = document.getElementById('fetchUnclassifiedBtn');
        const unclassifiedOutput = document.getElementById('unclassifiedOutput');
        const copyLinksBtn = document.getElementById('copyLinksBtn');

        if (fetchUnclassifiedBtn) {
            fetchUnclassifiedBtn.addEventListener('click', async () => {
                const limit = limitInput.value;
                fetchUnclassifiedBtn.disabled = true;
                fetchUnclassifiedBtn.textContent = 'è·å–ä¸­...';

                try {
                    const res = await fetch(`${apiBase}/api/unclassified_tweets?limit=${limit}`);
                    const data = await res.json();

                    if (data.links && data.links.length > 0) {
                        unclassifiedOutput.value = data.links.join('\n');
                        showResult('success', `æˆåŠŸè·å– ${data.links.length} æ¡å¾…åˆ†ç±»é“¾æ¥`); // Using existing showResult helper
                    } else {
                        unclassifiedOutput.value = '';
                        showResult('error', 'æœªæ‰¾åˆ°å¾…åˆ†ç±»æ•°æ®');
                    }
                } catch (e) {
                    showResult('error', `è·å–å¤±è´¥: ${e.message}`);
                } finally {
                    fetchUnclassifiedBtn.disabled = false;
                    fetchUnclassifiedBtn.textContent = 'ğŸ” è·å–å¾…åˆ†ç±»é“¾æ¥';
                }
            });

            copyLinksBtn.addEventListener('click', () => {
                if (!unclassifiedOutput.value) return;
                navigator.clipboard.writeText(unclassifiedOutput.value);
                const originalText = copyLinksBtn.textContent;
                copyLinksBtn.textContent = 'å·²å¤åˆ¶!';
                setTimeout(() => copyLinksBtn.textContent = originalText, 2000);
            });
        }
    </script>
</body>

</html>