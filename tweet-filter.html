<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tweet Filter | Twitter 链接筛选助手</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Source+Sans+3:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <!-- Core Styles -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <!-- Component Styles -->
    <link rel="stylesheet" href="tweet-detail-modal.css">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: "Inter", system-ui, sans-serif;
            min-height: 100vh;
            letter-spacing: 0.01em;
            line-height: 1.7;
            padding: 0 !important;
            /* Override styles.css padding-top: 64px */
        }

        /* SCROLLBAR STYLING - Using general styles from main.css */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.15) rgba(0, 0, 0, 0.3);
        }

        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        *::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            margin: 2px;
        }

        *::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.18);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.05);
            transition: all var(--transition-fast);
        }

        *::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
        }

        *::-webkit-scrollbar-thumb:active {
            background: rgba(255, 255, 255, 0.32);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.15);
        }

        .filter-layout {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }

        .filter-sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            /* Use bg-secondary from main styles */
            border-right: 1px solid var(--border);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            flex-shrink: 0;
            position: relative;
            overflow-y: auto;
            max-height: 100vh;
        }

        .filter-title {
            font-family: "Playfair Display", serif;
            font-size: 2rem;
            letter-spacing: -0.02em;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
            /* Use text-primary */
        }

        .filter-description {
            color: var(--text-muted);
            /* Use text-muted */
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.65rem;
            flex: 1;
        }

        /* New input field styles */
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: "Inter", system-ui, sans-serif;
            font-size: 0.875rem;
            line-height: 1.4;
            transition: all var(--transition-fast);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(var(--accent-primary-rgb), 0.2);
            background: var(--bg-card-hover);
        }

        textarea.input-field {
            resize: vertical;
            min-height: 0;
            max-height: 300px;
            line-height: 1.5;
        }



        /* Custom Checkbox styles */
        .custom-checkbox-wrapper {
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-primary);
            user-select: none;
            font-weight: 500;
        }

        .custom-checkbox-wrapper input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            height: 18px;
            width: 18px;
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-right: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }

        .custom-checkbox-wrapper input:checked~.checkmark {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .checkmark:after {
            content: "";
            width: 5px;
            height: 10px;
            border: solid var(--accent-foreground);
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .custom-checkbox-wrapper input:checked~.checkmark:after {
            opacity: 1;
        }

        .custom-checkbox-wrapper:hover input~.checkmark {
            border-color: var(--accent);
        }

        .form-group label {
            color: var(--text-secondary);
            /* Use text-secondary */
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .action-button {
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: "Inter", system-ui, sans-serif;
            /* Consistent font */
            font-size: 0.875rem;
            /* Consistent font size */
            font-weight: 500;
            /* Consistent font weight */
            padding: 0.65rem 1.25rem;
            /* Adjusted padding */
            border-radius: var(--radius-sm);
            /* Consistent border-radius */
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .action-button:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
            color: var(--text-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .action-button.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--accent-foreground);
            box-shadow: var(--shadow-accent);
        }

        .action-button.primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-accent);
        }


        .sidebar-actions {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        .filter-main {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            padding: 2rem 1.5rem;
            /* Adjusted to match sidebar padding */
            gap: 1.5rem;
            max-height: 100vh;
            overflow-y: auto;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
            justify-content: space-between;
        }

        .status-pill {
            font-family: "Inter", system-ui, sans-serif;
            /* Changed font */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            /* Adjusted letter-spacing */
            font-size: 0.8rem;
            color: var(--text-secondary);
            /* Changed color */
        }

        .select-all-wrap {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            /* Changed color */
            font-family: "Inter", system-ui, sans-serif;
            /* Changed font */
            letter-spacing: 0.05em;
            /* Adjusted letter-spacing */
            cursor: pointer;
            user-select: none;
            transition: color var(--transition-fast);
            /* Changed transition */
        }

        .select-all-wrap:hover {
            color: var(--accent);
        }

        .copy-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .preview-mode-toggle {
            display: flex;
            background: var(--bg-card);
            /* Changed background */
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 3px;
            gap: 0.25rem;
        }

        .preview-mode-toggle input {
            display: none;
        }

        .preview-mode-toggle label {
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-family: "Inter", system-ui, sans-serif;
            /* Changed font */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            /* Adjusted letter-spacing */
            color: var(--text-secondary);
            /* Changed color */
            cursor: pointer;
            transition: all var(--transition-fast);
            /* Changed transition */
        }

        .preview-mode-toggle input:checked+label {
            background: var(--bg-primary);
            /* Changed background */
            color: var(--accent);
        }

        /* Date Filter */
        .date-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            /* Changed to var(--radius-sm) */
            padding: 0.4rem 0.75rem;
            background: var(--bg-card);
            /* Changed to var(--bg-card) */
            font-size: 0.8rem;
            font-family: 'Inter', system-ui, sans-serif;
            /* Changed font */
        }

        .date-filter-label {
            color: var(--text-muted);
            /* Changed to var(--text-muted) */
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .date-chips {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }

        .date-chip {
            padding: 0.25rem 0.65rem;
            border-radius: 999px;
            background: var(--bg-primary);
            /* Changed to var(--bg-primary) */
            border: 1px solid var(--border);
            color: var(--text-secondary);
            /* Changed to var(--text-secondary) */
            font-size: 0.7rem;
            cursor: pointer;
            white-space: nowrap;
            /* Added for consistency */
            flex-shrink: 0;
            /* Added for consistency */
            transition: all var(--transition-fast);
            /* Changed transition */
            user-select: none;
        }

        .date-chip:first-child {
            /* Added for consistency */
            margin-left: 0;
        }

        .date-chip:last-child {
            /* Added for consistency */
            margin-right: 0;
        }

        .date-chip:hover {
            background: var(--bg-card-hover);
            /* Changed to var(--bg-card-hover) */
            color: var(--text-primary);
            /* Changed to var(--text-primary) */
            border-color: var(--border-hover);
            /* Changed to var(--border-hover) */
        }

        .date-chip.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--accent-foreground);
            box-shadow: 0 0 8px rgba(var(--accent-primary-rgb), 0.3);
            /* Changed accent-rgb to accent-primary-rgb */
        }

        .date-chip .count {
            opacity: 0.7;
            margin-left: 0.25rem;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            width: 38px;
            /* Changed width */
            height: 38px;
            /* Changed height */
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-card);
            /* Changed background */
            color: var(--text-primary);
            /* Changed color */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            /* Added box-shadow */
            flex-shrink: 0;
            transition: all var(--transition-fast);
            /* Changed transition */
        }

        .theme-toggle:hover {
            background: var(--accent);
            border-color: transparent;
            /* Changed border-color */
            color: var(--accent-foreground);
            transform: rotate(8deg);
            /* Changed transform */
            box-shadow: var(--shadow-md);
            /* Changed box-shadow */
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }

        .masonry-preview {
            column-count: 3;
            column-gap: var(--spacing-md);
            /* Use spacing variable */
        }

        @media (max-width: 1400px) {
            .masonry-preview {
                column-count: 2;
            }
        }

        @media (max-width: 900px) {
            .masonry-preview {
                column-count: 1;
            }
        }

        .tweet-card-wrapper {
            break-inside: avoid;
            margin-bottom: var(--spacing-sm);
            /* Use spacing variable */
            position: relative;
            background: transparent;
            border: none;
            border-radius: 0;
            overflow: visible;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .tweet-card-wrapper::before {
            display: none;
        }

        .tweet-card-wrapper:hover {
            transform: translateY(-2px);
        }

        .tweet-card-wrapper.selected {
            background: transparent;
        }

        .tweet-card-wrapper.unchecked {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .tweet-card-wrapper.unchecked:hover {
            opacity: 1;
            filter: grayscale(0);
        }

        .tweet-embed-container {
            padding: 0;
            background: transparent;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            pointer-events: auto;
            /* Changed from none to allow video interaction */
        }

        .tweet-embed-container:not(.loaded) {
            aspect-ratio: 1;
        }

        .tweet-embed-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--bg-card);
            /* Changed to bg-card */
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            /* Use radius variable */
            opacity: 1;
            transition: opacity var(--transition-fast);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            z-index: 0;
        }

        .tweet-embed-container.loaded {
            min-height: auto;
        }

        .tweet-embed-container.loaded::before {
            opacity: 0;
            animation: none;
        }

        .tweet-embed-container>* {
            position: relative;
            z-index: 1;
        }

        .tweet-embed-container .twitter-tweet,
        .tweet-embed-container blockquote.twitter-tweet {
            margin: 0 !important;
        }

        .tweet-card-wrapper>.tweet-card-footer {
            display: none;
        }

        .tweet-card-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 100;
            display: flex;
            gap: 8px;
            opacity: 0;
            transform: translateY(-4px);
            transition: all var(--transition-fast);
            pointer-events: none;
        }

        .tweet-card-wrapper:hover .tweet-card-actions {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .card-select-btn,
        .card-link-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-card);
            /* Changed to bg-card */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            backdrop-filter: blur(8px);
        }

        .card-link-btn {
            text-decoration: none;
            color: var(--text-secondary);
            /* Changed to text-secondary */
        }

        .card-link-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--accent-foreground);
        }

        .card-select-btn {
            position: relative;
        }

        .card-select-btn input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
            margin: 0;
            z-index: 2;
        }

        .card-select-indicator {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
            pointer-events: none;
        }

        .card-select-indicator svg {
            width: 18px;
            height: 18px;
            opacity: 0;
            stroke: currentColor;
            stroke-width: 3;
            fill: none;
            transform: scale(0.85);
            transition: all var(--transition-fast);
        }

        .card-select-btn input:checked+.card-select-indicator {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--accent-foreground);
            box-shadow: var(--shadow-accent);
        }

        .card-select-btn input:checked+.card-select-indicator svg {
            opacity: 1;
            transform: scale(1);
        }

        .image-mode-grid {
            display: flex;
            gap: 4px;
            align-items: flex-start;
        }

        .masonry-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        /* Removed column-count based media queries as we handle columns in JS now */

        .image-mode-card {
            background: var(--bg-card);
            /* Changed to bg-card */
            border-radius: var(--radius-sm);
            /* Use radius variable */
            overflow: hidden;
            border: 1px solid var(--border);
            break-inside: avoid;
            margin-bottom: 3px;
            transition: all var(--transition-fast);
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .image-mode-card:hover {
            border-color: var(--accent);
            /* Changed to accent */
        }

        .image-mode-card.selected {
            background: rgba(var(--accent-primary-rgb), 0.02);
            /* Changed to accent-primary-rgb */
            border-color: rgba(var(--accent-primary-rgb), 0.3);
            /* Changed to accent-primary-rgb */
        }

        /* Removed Light mode adjustments for image cards, rely on global vars */

        .image-mode-card.unchecked {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .image-mode-card.unchecked:hover {
            opacity: 1;
            filter: grayscale(0);
        }

        .image-mode-card img {
            width: 100%;
            height: auto;
            display: block;
        }

        .image-mode-card .loading-placeholder {
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
            /* Changed to text-muted */
        }

        .image-card-info {
            padding: 0.65rem;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            border-top: 1px solid var(--border);
            background: var(--bg-card);
            /* Changed to bg-card */
            font-size: 0.8rem;
        }

        .image-card-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .image-card-username {
            color: var(--text-secondary);
            /* Changed to text-secondary */
            font-family: 'Inter', system-ui, sans-serif;
            /* Changed font */
            font-size: 0.75rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .image-card-likes {
            color: var(--accent);
            font-family: 'Inter', system-ui, sans-serif;
            /* Changed font */
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            flex-shrink: 0;
        }

        .image-card-likes svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .image-card-char-count {
            color: var(--text-muted);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            flex-shrink: 0;
            padding: 2px 6px;
            background: rgba(var(--accent-primary-rgb), 0.1);
            border-radius: 4px;
            border: 1px solid rgba(var(--accent-primary-rgb), 0.2);
        }

        .image-card-date {
            color: var(--text-muted);
            /* Changed to text-muted */
            font-family: 'Inter', system-ui, sans-serif;
            /* Changed font */
            font-size: 0.7rem;
            opacity: 0.8;
        }

        /* Tweet Detail Modal styles moved to tweet-detail-modal.css */

        .image-card-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 100;
            display: flex;
            gap: 8px;
            opacity: 0;
            transform: translateY(-4px);
            transition: all var(--transition-fast);
            pointer-events: none;
        }

        .image-mode-card:hover .image-card-actions {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .image-card-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-card);
            /* Changed to bg-card */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            backdrop-filter: blur(8px);
            color: var(--text-secondary);
            /* Changed to text-secondary */
        }

        .image-card-action-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--accent-foreground);
        }

        .image-card-action-btn svg {
            width: 16px;
            height: 16px;
        }

        .image-card-action-btn.copied {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--accent-foreground);
        }

        .image-card-check-indicator {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            background: var(--bg-card);
            /* Changed to bg-card */
            border: 2px solid var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all var(--transition-fast);
            backdrop-filter: blur(8px);
            z-index: 90;
        }

        .image-mode-card:hover .image-card-check-indicator,
        .image-mode-card.selected .image-card-check-indicator {
            opacity: 1;
        }

        .image-mode-card.selected .image-card-check-indicator {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--accent-foreground);
            box-shadow: var(--shadow-accent);
        }

        .status-message {
            padding: 0.65rem 1rem;
            border-radius: 999px;
            background: var(--bg-card);
            /* Changed to bg-card */
            font-size: 0.85rem;
            color: var(--text-secondary);
            /* Changed to text-secondary */
            display: none;
        }


        .status-message.success {
            color: var(--accent-secondary);
        }

        .sidebar-links {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .home-link,
        .twitter-link {
            padding: 8px 14px;
            /* Adjusted padding */
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            /* Adjusted border-radius */
            text-decoration: none;
            color: var(--text-secondary);
            /* Changed color */
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all var(--transition-fast);
            /* Changed transition */
            font-family: 'Inter', system-ui, sans-serif;
            /* Changed font */
            letter-spacing: 0.02em;
            /* Adjusted letter-spacing */
            background: var(--bg-card);
            /* Added background */
        }

        .home-link:hover,
        .twitter-link:hover {
            background: var(--bg-card-hover);
            /* Changed background */
            border-color: var(--border-hover);
            /* Changed border-color */
            color: var(--text-primary);
            /* Changed color */
            transform: translateY(-1px);
        }

        .home-link svg,
        .twitter-link svg {
            width: 16px;
            /* Set explicit width */
            height: 16px;
            /* Set explicit height */
            flex-shrink: 0;
            /* Prevent shrinking */
        }


        @keyframes pulse {
            0% {
                opacity: 0.3;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 0.3;
            }
        }

        @media (max-width: 1080px) {
            .filter-layout {
                flex-direction: column;
            }

            .filter-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border);
                max-height: none;
                overflow: visible;
                position: static;
            }

            .filter-main {
                padding: var(--spacing-md);
                /* Changed to use CSS variable */
                max-height: none;
                overflow: visible;
            }

            .date-filter {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
            }

            .date-chips {
                width: 100%;
            }

            .masonry-preview {
                column-count: 1;
            }
        }
    </style>
</head>

<body>
    <div class="filter-layout">
        <aside class="filter-sidebar">
            <div>
                <div class="filter-title">Tweet Filter</div>
                <div class="filter-description">Paste links, preview tweets, select and copy.</div>
            </div>
            <div class="form-group">
                <label for="rawInput">Paste Links</label>
                <textarea id="rawInput" placeholder="https://twitter.com/..." spellcheck="false"
                    class="input-field"></textarea>
            </div>
            <div class="form-group">
                <label for="includeKeywords">Include Keywords</label>
                <textarea id="includeKeywords" placeholder="Space separated (AND logic)" rows="1" spellcheck="false"
                    class="input-field"></textarea>
            </div>
            <div class="form-group">
                <label for="excludeKeywords">Exclude Keywords</label>
                <textarea id="excludeKeywords" placeholder="Space separated (OR logic)" rows="1" spellcheck="false"
                    class="input-field"></textarea>
            </div>
            <div class="filter-group">
                <label for="minLikes">Min Likes:</label>
                <input type="text" id="minLikes" placeholder="e.g., 100" class="input-field">
            </div>
            <div class="filter-group">
                <label for="minTextLength">Min Text Length:</label>
                <input type="text" id="minTextLength" placeholder="e.g., 50" class="input-field">
            </div>
            <div class="filter-group">
                <label for="maxTextLength">Max Text Length:</label>
                <input type="text" id="maxTextLength" placeholder="e.g., 280" class="input-field">
            </div>


            <div class="sidebar-actions">
                <button id="refreshPreviewBtn" class="action-button" type="button">Preview</button>
                <button id="clearInputBtn" class="action-button" type="button">Clear</button>
                <button id="copySelectedBtn" class="action-button primary" type="button">Copy Links</button>
            </div>
            <div id="sidebarStatus" class="status-message" role="status"></div>
            <div class="sidebar-links">
                <a href="index.html" class="home-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                    </svg>
                    Trending Monitor
                </a>
                <a href="https://x.com/ttmouse" target="_blank" rel="noopener" class="twitter-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                    </svg>
                    Follow @ttmouse
                </a>
            </div>
        </aside>

        <main class="filter-main">
            <div class="toolbar">
                <div class="copy-info">
                    <span class="status-pill">Detected <span id="linkCount">0</span> links</span>
                    <span class="status-pill">Selected <span id="selectedCount">0</span></span>
                    <label class="select-all-wrap">
                        <input type="checkbox" id="selectAll" checked>
                        Select All
                    </label>
                </div>
                <div class="preview-mode-toggle">
                    <input type="radio" name="previewMode" id="modeStandard" value="standard">
                    <label for="modeStandard">Tweets</label>
                    <input type="radio" name="previewMode" id="modeImages" value="images" checked>
                    <label for="modeImages">Images</label>
                </div>
                <div class="date-filter" id="dateFilter" style="display: none;">
                    <span class="date-filter-label">Date</span>
                    <div class="date-chips" id="dateChips"></div>
                </div>
                <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme"
                    title="Toggle theme">
                    <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
            <div class="masonry-preview" id="linkList"></div>
            <div class="image-mode-grid" id="linkListImages" style="display: none;"></div>
        </main>
    </div>

    <script>
        // Initialize theme immediately to prevent flash
        (function () {
            const savedTheme = localStorage.getItem('site-theme') || 'dark';
            if (savedTheme === 'light') {
                document.documentElement.classList.add('light-mode');
            }
        })();

        // Theme toggle functionality
        const sunIcon = `
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        `;
        const moonIcon = `
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        `;

        function updateThemeIcon() {
            const themeIcon = document.getElementById('themeIcon');
            const isLight = document.body.classList.contains('light-mode');
            if (themeIcon) {
                themeIcon.innerHTML = isLight ? moonIcon : sunIcon;
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            localStorage.setItem('tweet-filter-theme', theme);
            updateThemeIcon();

            // 重新渲染所有已加载的Twitter卡片
            reloadTwitterCards();
        }

        // 获取当前主题
        function getCurrentTheme() {
            return document.body.classList.contains('light-mode') ? 'light' : 'dark';
        }

        // 重新渲染所有Twitter卡片
        function reloadTwitterCards() {
            const loadedContainers = document.querySelectorAll('.tweet-embed-container.loaded');
            loadedContainers.forEach(container => {
                if (container.classList.contains('error')) return; // 跳过错误的
                const tweetUrl = container.dataset.tweetUrl;
                if (tweetUrl) {
                    const tweetId = extractTweetId(tweetUrl);
                    if (tweetId && window.twttr && window.twttr.widgets) {
                        loadTweetEmbed(container, true);
                    }
                }
            });
        }

        // Initialize icon on load
        document.addEventListener('DOMContentLoaded', () => {
            updateThemeIcon();
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
        });

        const IMPORT_CACHE_KEY = 'tweet-filter-content';
        const MAX_CONCURRENT_LOADS = 4;
        let tweetObserver = null;
        const loadingQueue = new Set();
        let lastRenderedUrlsKey = '';
        let twitterSdkReadyResolved = false;
        let twitterSdkReadyResolver = null;
        const twitterSdkReadyPromise = new Promise(resolve => {
            twitterSdkReadyResolver = () => {
                if (twitterSdkReadyResolved) return;
                twitterSdkReadyResolved = true;
                resolve();
            };
        });

        function watchTwitterSdkReady() {
            if (twitterSdkReadyResolved) return;
            if (window.twttr && window.twttr.widgets) {
                twitterSdkReadyResolver();
                return;
            }
            if (window.twttr && typeof window.twttr.ready === 'function') {
                window.twttr.ready(() => twitterSdkReadyResolver());
                return;
            }
            requestAnimationFrame(watchTwitterSdkReady);
        }

        watchTwitterSdkReady();

        function extractUrls(text) {
            const regex = /https?:\/\/(?:x|twitter)\.com\/[a-zA-Z0-9_]+\/status\/\d+/gi;
            const matches = text.match(regex) || [];
            return [...new Set(matches.map(url => url.replace('x.com', 'twitter.com')))];
        }

        function extractTweetId(url) {
            const match = url.match(/status\/(\d+)/);
            return match ? match[1] : null;
        }

        // 全局变量追踪选中的日期
        let selectedDates = new Set();

        // Modal 导航全局变量已移至 tweet-detail-modal.js

        // 从已加载的卡片中收集日期信息并初始化筛选器
        function initializeDateFilterFromCards() {
            const dateMap = new Map(); // date -> count
            const cards = document.querySelectorAll('.image-mode-card[data-date]');

            cards.forEach(card => {
                const date = card.dataset.date;
                if (date) {
                    dateMap.set(date, (dateMap.get(date) || 0) + 1);
                }
            });

            // 如果没有日期数据，隐藏筛选器
            if (dateMap.size === 0) {
                document.getElementById('dateFilter').style.display = 'none';
                return;
            }

            // 显示筛选器
            document.getElementById('dateFilter').style.display = 'flex';

            // 按日期降序排序
            const sortedDates = Array.from(dateMap.entries()).sort((a, b) => b[0].localeCompare(a[0]));

            // 渲染日期chips
            const chipsContainer = document.getElementById('dateChips');
            chipsContainer.innerHTML = '';

            sortedDates.forEach(([date, count]) => {
                const chip = document.createElement('div');
                chip.className = 'date-chip active'; // 默认全部激活
                chip.dataset.date = date;

                // 格式化日期显示
                const dateObj = new Date(date);
                const displayDate = dateObj.toLocaleDateString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit'
                });

                chip.innerHTML = `${displayDate}<span class="count">(${count})</span>`;

                chip.addEventListener('click', () => {
                    toggleDateFilter(date, chip);
                });

                chipsContainer.appendChild(chip);
            });

            // 默认全部选中
            selectedDates.clear();
            sortedDates.forEach(([date]) => selectedDates.add(date));
        }

        // 切换日期筛选（多选模式）
        function toggleDateFilter(date, chipElement) {
            if (selectedDates.has(date)) {
                // 取消选中
                selectedDates.delete(date);
                chipElement.classList.remove('active');
            } else {
                // 选中
                selectedDates.add(date);
                chipElement.classList.add('active');
            }

            // 重新渲染内容
            applyFilters();
        }

        // 综合筛选（日期 + 关键词）
        function applyFilters() {
            const allCards = Array.from(document.querySelectorAll('.image-mode-card'));
            const container = document.getElementById('linkListImages');

            // 获取关键词配置
            const includeInput = document.getElementById('includeKeywords').value.trim().toLowerCase();
            const excludeInput = document.getElementById('excludeKeywords').value.trim().toLowerCase();
            const includeKeys = includeInput ? includeInput.split(/\s+/) : [];
            const excludeKeys = excludeInput ? excludeInput.split(/\s+/) : [];

            // 获取文本长度筛选配置
            const minTextLength = parseInt(document.getElementById('minTextLength').value.trim());
            const maxTextLength = parseInt(document.getElementById('maxTextLength').value.trim());

            // 获取 'Verified Accounts' 配置


            // 获取 'Min Likes' 配置
            const minLikes = parseInt(document.getElementById('minLikes').value.trim());


            // 先设置显隐状态
            allCards.forEach(card => {
                let isVisible = true;

                // 1. 日期筛选
                const date = card.dataset.date;
                if (selectedDates.size > 0 && (!date || !selectedDates.has(date))) {
                    isVisible = false;
                }

                // 2. 关键词筛选 (仅当目前可见且有数据时)
                if (isVisible && (includeKeys.length > 0 || excludeKeys.length > 0 || !isNaN(minTextLength) || !isNaN(maxTextLength) || !isNaN(minLikes)) && card.dataset.tweetData) {
                    try {
                        const data = JSON.parse(card.dataset.tweetData);
                        // 组合所有可能包含文本的字段
                        const text = [
                            data.text,
                            data.full_text,
                            data.user_name,
                            data.user_screen_name
                        ].filter(Boolean).join(' ').toLowerCase();

                        // 包含逻辑 (AND)
                        if (includeKeys.length > 0) {
                            const allFound = includeKeys.every(key => text.includes(key));
                            if (!allFound) isVisible = false;
                        }

                        // 排除逻辑 (OR)
                        if (isVisible && excludeKeys.length > 0) {
                            const anyFound = excludeKeys.some(key => text.includes(key));
                            if (anyFound) isVisible = false;
                        }

                        // 3. 文本长度筛选
                        if (isVisible && (!isNaN(minTextLength) || !isNaN(maxTextLength))) {
                            const tweetTextContent = data.full_text || data.text || '';
                            const currentTextLength = tweetTextContent.length;

                            if (!isNaN(minTextLength) && currentTextLength < minTextLength) {
                                isVisible = false;
                            }
                            if (isVisible && !isNaN(maxTextLength) && currentTextLength > maxTextLength) {
                                isVisible = false;
                            }
                        }



                        // 5. Min Likes 筛选
                        if (isVisible && !isNaN(minLikes) && (data.favorite_count || 0) < minLikes) {
                            isVisible = false;
                        }

                    } catch (e) {
                        console.error('Filter error:', e);
                    }
                }

                card.style.display = isVisible ? '' : 'none';
            });

            // 重新布局以填补空缺
            // 保持按点赞数排序的顺序
            allCards.sort((a, b) => {
                const likesA = parseInt(a.dataset.likes) || 0;
                const likesB = parseInt(b.dataset.likes) || 0;
                if (likesB !== likesA) return likesB - likesA;
                return parseInt(a.dataset.index) - parseInt(b.dataset.index);
            });

            distributeCardsToColumns(container, allCards);

            // 更新计数
            updateCounts();
        }

        function updateCounts() {
            // 只统计当前模式下可见的项目
            const mode = document.querySelector('input[name="previewMode"]:checked').value;
            const currentContainer = mode === 'images'
                ? document.getElementById('linkListImages')
                : document.getElementById('linkList');

            const allVisible = Array.from(currentContainer.querySelectorAll('.tweet-check-input')).filter(cb => {
                const card = cb.closest('.tweet-card-wrapper, .image-mode-card');
                return card && card.style.display !== 'none';
            });

            const total = allVisible.length;
            const selected = allVisible.filter(cb => cb.checked).length;

            console.log('[Debug] updateCounts - Mode:', mode, 'Total visible:', total, 'Selected:', selected);

            document.getElementById('linkCount').textContent = total;
            document.getElementById('selectedCount').textContent = selected;
            document.getElementById('selectAll').checked = total > 0 && total === selected;
        }

        function toggleItemStyle(checkbox) {
            const wrapper = checkbox.closest('.tweet-card-wrapper') || checkbox.closest('.image-mode-card');
            if (!wrapper) return;
            if (checkbox.checked) {
                wrapper.classList.remove('unchecked');
                wrapper.classList.add('selected');
            } else {
                wrapper.classList.add('unchecked');
                wrapper.classList.remove('selected');
            }
            updateCounts();
        }

        async function copySelectedLinks() {
            // 只复制当前模式下可见且选中的链接
            const mode = document.querySelector('input[name="previewMode"]:checked').value;
            const currentContainer = mode === 'images'
                ? document.getElementById('linkListImages')
                : document.getElementById('linkList');

            const selected = Array.from(currentContainer.querySelectorAll('.tweet-check-input:checked'))
                .filter(cb => {
                    const card = cb.closest('.tweet-card-wrapper, .image-mode-card');
                    return card && card.style.display !== 'none';
                })
                .map(cb => cb.value);

            if (selected.length === 0) {
                showStatus('Please select links to keep first', 'error');
                return;
            }

            try {
                await navigator.clipboard.writeText(selected.join('\n'));
                showStatus(`Copied ${selected.length} links`, 'success');
            } catch (err) {
                console.error(err);
                showStatus('Copy failed, please retry', 'error');
            }
        }

        function showStatus(message, type = 'info') {
            const box = document.getElementById('sidebarStatus');
            box.textContent = message;
            box.classList.remove('success');
            if (type === 'success') {
                box.classList.add('success');
            }
            box.style.display = 'block';
            clearTimeout(box._timer);
            box._timer = setTimeout(() => box.style.display = 'none', 3000);
        }

        function updatePreview(urls) {
            console.log('[Debug] updatePreview called with', urls.length, 'URLs');
            const mode = document.querySelector('input[name="previewMode"]:checked').value;
            const listStandard = document.getElementById('linkList');
            const listImages = document.getElementById('linkListImages');
            const urlsKey = JSON.stringify(urls);
            const target = mode === 'images' ? listImages : listStandard;
            const dataChanged = urlsKey !== lastRenderedUrlsKey;

            console.log('[Debug] Mode:', mode, 'DataChanged:', dataChanged, 'Target has', target.childElementCount, 'children');

            // 如果切换到 Tweet 模式，隐藏日期筛选器
            if (mode === 'standard') {
                document.getElementById('dateFilter').style.display = 'none';
            }

            if (dataChanged) {
                lastRenderedUrlsKey = urlsKey;
                listStandard.dataset.renderKey = '';
                listImages.dataset.renderKey = '';
                listStandard.innerHTML = '';
                listImages.innerHTML = '';
                loadingQueue.clear();
                if (tweetObserver) {
                    tweetObserver.disconnect();
                    tweetObserver = null;
                }
            }

            listStandard.style.display = mode === 'standard' ? '' : 'none';
            listImages.style.display = mode === 'images' ? '' : 'none';

            if (!urls.length) {
                target.innerHTML = '<div style="text-align:center;padding:4rem;color:var(--muted-foreground);font-family:\'IBM Plex Mono\',monospace;text-transform:uppercase;letter-spacing:0.2em;">No links yet</div>';
                target.dataset.renderKey = 'empty';
                document.getElementById('linkCount').textContent = '0';
                document.getElementById('selectedCount').textContent = '0';
                document.getElementById('selectAll').checked = false;
                return;
            }

            const needsRender = dataChanged || target.dataset.renderKey !== urlsKey || !target.childElementCount;
            if (!needsRender) {
                updateCounts();
                // 如果是 Image 模式且已经有卡片，重新显示日期筛选器
                if (mode === 'images') {
                    const cards = document.querySelectorAll('.image-mode-card[data-date]');
                    if (cards.length > 0) {
                        initializeDateFilterFromCards();
                    }
                }
                return;
            }

            target.innerHTML = '';

            if (mode === 'images') {
                renderImagePreview(urls, target);
            } else {
                urls.forEach((url, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'tweet-card-wrapper selected';
                    wrapper.innerHTML = `
                        <div class="tweet-card-actions">
                            <div class="card-select-btn">
                                <input type="checkbox" class="tweet-check-input" value="${url}" checked>
                                <span class="card-select-indicator">
                                    <svg viewBox="0 0 24 24">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </span>
                            </div>
                            <a class="card-link-btn" href="${url}" target="_blank" rel="noopener">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"></path>
                                </svg>
                            </a>
                        </div>
                        <div class="tweet-embed-container" id="tweet-preview-${index}" data-tweet-url="${url}"></div>
                    `;
                    target.appendChild(wrapper);
                });
                initializeTweetLazyLoading();
            }

            target.dataset.renderKey = urlsKey;
            updateCounts();
        }

        function getMasonryColumnCount() {
            const width = window.innerWidth;
            if (width <= 540) return 1;
            if (width <= 900) return 2;
            if (width <= 1200) return 3;
            return 4;
        }

        function distributeCardsToColumns(container, cards) {
            // 保存当前的滚动位置（如果需要）

            container.innerHTML = '';
            const colCount = getMasonryColumnCount();
            const columns = [];

            // 创建列
            for (let i = 0; i < colCount; i++) {
                const col = document.createElement('div');
                col.className = 'masonry-column';
                columns.push(col);
                container.appendChild(col);
            }

            // 分配卡片
            cards.forEach((card, index) => {
                if (index < colCount) {
                    // 第一行直接按顺序填充
                    columns[index].appendChild(card);
                } else {
                    // 后续行填充到最短的列
                    let minHeight = Infinity;
                    let targetCol = columns[0];

                    columns.forEach(col => {
                        // 使用 offsetHeight 获取高度，这会触发回流，但在卡片数量不多时可以接受
                        if (col.offsetHeight < minHeight) {
                            minHeight = col.offsetHeight;
                            targetCol = col;
                        }
                    });

                    targetCol.appendChild(card);
                }
            });
        }

        function renderImagePreview(urls, container) {
            console.log('[Debug] renderImagePreview called with', urls.length, 'URLs');
            // 不要立即清空，让 distributeCardsToColumns 处理
            // container.innerHTML = ''; 

            let loadedCount = 0;
            const totalUrls = urls.length;
            const cards = [];

            urls.forEach((url, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'image-mode-card selected';
                wrapper.dataset.url = url;
                wrapper.dataset.index = index;
                wrapper.dataset.likes = '0'; // Default likes count for sorting
                wrapper.innerHTML = `
                    <input type="checkbox" class="tweet-check-input" value="${url}" checked hidden>
                    <div class="image-card-check-indicator">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="image-card-actions">
                        <button class="image-card-action-btn image-card-copy-btn" type="button" title="Copy link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                        <button class="image-card-action-btn image-card-detail-btn" type="button" title="View details" data-tweet-id="${extractTweetId(url)}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                        </button>
                        <a class="image-card-action-btn" href="${url}" target="_blank" rel="noopener" title="Open tweet">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"></path>
                            </svg>
                        </a>
                    </div>
                    <div class="loading-placeholder" id="img-load-${index}" style="display:flex;align-items:center;justify-content:center;padding:2rem;color:var(--muted-foreground);font-size:0.85rem;">Loading…</div>
                    <div class="image-card-info" id="img-info-${index}" style="display:none;">
                        <div class="image-card-meta">
                            <span class="image-card-username">@username</span>
                            <span class="image-card-char-count" id="img-chars-${index}" style="display:none;"></span>
                            <span class="image-card-likes">
                                <svg viewBox="0 0 24 24">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                                <span>0</span>
                            </span>
                        </div>
                        <div class="image-card-date" id="img-date-${index}"></div>
                    </div>
                `;

                // 点击卡片切换选中状态（但不包括按钮区域）
                wrapper.addEventListener('click', (e) => {
                    // 如果点击的是操作按钮区域，不触发选中切换
                    if (e.target.closest('.image-card-actions')) {
                        return;
                    }
                    const checkbox = wrapper.querySelector('.tweet-check-input');
                    if (!checkbox) return;
                    checkbox.checked = !checkbox.checked;
                    toggleItemStyle(checkbox);
                });

                // 复制链接按钮
                const copyBtn = wrapper.querySelector('.image-card-copy-btn');
                copyBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    try {
                        await navigator.clipboard.writeText(url);
                        copyBtn.classList.add('copied');
                        setTimeout(() => {
                            copyBtn.classList.remove('copied');
                        }, 1500);
                    } catch (err) {
                        console.error('Copy failed:', err);
                    }
                });

                cards.push(wrapper);

                const id = extractTweetId(url);
                if (!id) {
                    loadedCount++;
                    return;
                }

                console.log('[Debug] Processing tweet', index + 1, '/', totalUrls, 'ID:', id);

                fetch(`/api/tweet_info?id=${id}`)
                    .then(res => res.json())
                    .then(data => {
                        const placeholder = document.getElementById(`img-load-${index}`);
                        const infoBar = document.getElementById(`img-info-${index}`);
                        if (!placeholder) return;

                        let imgUrl = null;
                        let isVideo = false;

                        // 优先从 media_extended 获取媒体
                        if (Array.isArray(data.media_extended)) {
                            // 先找图片
                            let found = data.media_extended.find(item => item.type === 'image' && item.url);
                            if (found) {
                                imgUrl = found.url;
                            } else {
                                // 如果没有图片，找视频的缩略图
                                found = data.media_extended.find(item => item.type === 'video');
                                if (found) {
                                    isVideo = true;
                                    // VxTwitter 通常会提供 thumbnail_url 或使用第一帧
                                    imgUrl = found.thumbnail_url || found.url;
                                }
                            }
                        }

                        // 降级方案：使用 mediaURLs
                        if (!imgUrl && Array.isArray(data.mediaURLs) && data.mediaURLs.length) {
                            imgUrl = data.mediaURLs[0];
                        }

                        if (imgUrl) {
                            const mediaHTML = isVideo
                                ? `<div style="position:relative;">
                                    <img src="${imgUrl}" alt="Video thumbnail" loading="lazy">
                                    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:48px;height:48px;background:rgba(0,0,0,0.7);border-radius:50%;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                            <path d="M8 5v14l11-7z"/>
                                        </svg>
                                    </div>
                                   </div>`
                                : `<img src="${imgUrl}" alt="Tweet image" loading="lazy">`;
                            placeholder.outerHTML = mediaHTML;
                        } else {
                            placeholder.innerHTML = 'No media found';
                        }

                        // 更新信息栏和排序属性
                        if (infoBar) {
                            const username = data.user_screen_name || data.user_name || 'Unknown';
                            const likes = data.likes || 0;
                            const formattedLikes = likes >= 1000
                                ? (likes / 1000).toFixed(1) + 'K'
                                : likes.toString();

                            // 存储原始点赞数用于排序
                            wrapper.dataset.likes = likes.toString();

                            // 存储日期用于筛选（格式：YYYY-MM-DD，使用本地时区）
                            if (data.date) {
                                const date = new Date(data.date);
                                // 使用本地时区的日期，而不是 UTC
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const day = String(date.getDate()).padStart(2, '0');
                                const dateStr = `${year}-${month}-${day}`;
                                wrapper.dataset.date = dateStr;
                            }

                            infoBar.querySelector('.image-card-username').textContent = `@${username}`;
                            infoBar.querySelector('.image-card-likes span').textContent = formattedLikes;

                            // 显示字符数
                            const charCountElement = document.getElementById(`img-chars-${index}`);
                            if (charCountElement) {
                                const tweetText = data.full_text || data.text || '';
                                const charCount = tweetText.length;
                                if (charCount > 0) {
                                    charCountElement.textContent = `${charCount} chars`;
                                    charCountElement.title = `${charCount} characters`;
                                    charCountElement.style.display = 'flex';
                                }
                            }

                            // 显示日期时间
                            const dateElement = document.getElementById(`img-date-${index}`);
                            if (dateElement && data.date) {
                                // 直接显示具体日期时间
                                const date = new Date(data.date);
                                const timeStr = date.toLocaleString('zh-CN', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                dateElement.textContent = timeStr;
                            }

                            // 存储完整数据到wrapper，供Modal使用
                            wrapper.dataset.tweetData = JSON.stringify(data);

                            infoBar.style.display = 'flex';
                        }

                        loadedCount++;
                        // 所有数据加载完成后，按点赞数排序并初始化日期筛选器
                        if (loadedCount === totalUrls) {
                            initializeDateFilterFromCards();
                            applyFilters();
                        }
                    })
                    .catch(() => {
                        const placeholder = document.getElementById(`img-load-${index}`);
                        if (placeholder) placeholder.innerHTML = 'Load failed';
                        loadedCount++;
                        // 即使有失败的，也要检查是否全部处理完
                        if (loadedCount === totalUrls) {
                            initializeDateFilterFromCards();
                            applyFilters();
                        }
                    });
            });

            // 初始分配卡片到列
            distributeCardsToColumns(container, cards);
        }

        // 按点赞数对图片卡片进行降序排序 (已废弃，功能合并入 applyFilters)
        // function sortImageCardsByLikes(container) { ... }

        function initializeTweetLazyLoading() {
            if (tweetObserver) {
                tweetObserver.disconnect();
            }

            const containers = document.querySelectorAll('.tweet-embed-container:not(.loaded)');
            if (!containers.length) return;

            tweetObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) return;
                    const container = entry.target;
                    if (container.classList.contains('loaded') || loadingQueue.has(container.id)) return;

                    if (loadingQueue.size < MAX_CONCURRENT_LOADS) {
                        container.classList.add('loading');
                        loadingQueue.add(container.id);
                        loadTweetEmbed(container);
                        tweetObserver.unobserve(container);
                    }
                });
            }, {
                root: null,
                rootMargin: '800px',
                threshold: 0.01
            });

            containers.forEach(container => tweetObserver.observe(container));
            fillLoadingQueue();
        }

        function fillLoadingQueue() {
            const waiting = Array.from(document.querySelectorAll('.tweet-embed-container:not(.loaded):not(.loading)'))
                .filter(el => !loadingQueue.has(el.id));
            if (!waiting.length) return;

            const available = MAX_CONCURRENT_LOADS - loadingQueue.size;
            if (available <= 0) return;

            waiting.slice(0, available).forEach(container => {
                container.classList.add('loading');
                loadingQueue.add(container.id);
                loadTweetEmbed(container);
                if (tweetObserver) tweetObserver.unobserve(container);
            });
        }

        async function loadTweetEmbed(container, isRetry = false) {
            if (!container) return;

            if (!twitterSdkReadyResolved) {
                try {
                    await twitterSdkReadyPromise;
                } catch (err) {
                    console.error('Twitter SDK wait error', err);
                }
            }

            const tweetId = extractTweetId(container.dataset.tweetUrl);
            if (!tweetId || !window.twttr || !window.twttr.widgets) {
                showRetryButton(container, 'Twitter SDK 未加载');
                container.classList.add('loaded', 'error');
                container.classList.remove('loading');
                loadingQueue.delete(container.id);
                fillLoadingQueue();
                return;
            }

            if (isRetry) {
                container.innerHTML = '';
                container.classList.remove('error');
                container.classList.add('loading');
            }

            window.twttr.widgets.createTweet(tweetId, container, {
                theme: getCurrentTheme(),
                dnt: true,
                conversation: 'none',
                cards: 'visible',
                width: 520,
                chrome: 'nofooter'
            }).then(() => {
                container.classList.remove('loading', 'error');
                container.classList.add('loaded');
                loadingQueue.delete(container.id);
                fillLoadingQueue();
            }).catch(() => {
                showRetryButton(container, '加载失败，点击重试');
                container.classList.add('error', 'loaded');
                container.classList.remove('loading');
                loadingQueue.delete(container.id);
                fillLoadingQueue();
            });
        }

        function showRetryButton(container, message) {
            container.innerHTML = `
                <div style="text-align:center;padding:2rem;color:var(--muted-foreground);display:flex;flex-direction:column;gap:0.75rem;align-items:center;">
                    <div>${message}</div>
                    <button class="btn primary" type="button" onclick="retryLoad('${container.id}')">重试</button>
                </div>
            `;
        }

        window.retryLoad = function (id) {
            const el = document.getElementById(id);
            if (el) {
                loadTweetEmbed(el, true);
            }
        };

        function retryAllFailedTweets() {
            const failedContainers = document.querySelectorAll('.tweet-embed-container.error');
            if (failedContainers.length === 0) {
                return false;
            }

            failedContainers.forEach(container => {
                container.classList.remove('loaded', 'error');
                loadingQueue.delete(container.id);
            });

            initializeTweetLazyLoading();
            return true;
        }

        document.addEventListener('click', (event) => {
            const selectBtn = event.target.closest('.card-select-btn');
            if (!selectBtn) return;
            const checkbox = selectBtn.querySelector('.tweet-check-input');
            if (!checkbox) return;
            if (event.target === checkbox) return;
            event.preventDefault();
            checkbox.checked = !checkbox.checked;
            toggleItemStyle(checkbox);
        });

        // Click entire card to toggle selection
        document.addEventListener('click', (event) => {
            // Ignore clicks on action buttons
            if (event.target.closest('.card-select-btn') ||
                event.target.closest('.card-link-btn') ||
                event.target.closest('.card-delete-btn')) {
                return;
            }

            const wrapper = event.target.closest('.tweet-card-wrapper');
            if (!wrapper) return;

            const checkbox = wrapper.querySelector('.tweet-check-input');
            if (!checkbox) return;

            checkbox.checked = !checkbox.checked;
            toggleItemStyle(checkbox);
        });

        document.addEventListener('change', (event) => {
            if (event.target.classList && event.target.classList.contains('tweet-check-input')) {
                toggleItemStyle(event.target);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('rawInput');
            const selectAll = document.getElementById('selectAll');
            const copyBtn = document.getElementById('copySelectedBtn');
            const clearBtn = document.getElementById('clearInputBtn');
            const refreshBtn = document.getElementById('refreshPreviewBtn');
            let inputUpdateTimer = null;
            const runTextareaPreviewUpdate = () => updatePreview(extractUrls(textarea.value));
            const scheduleTextareaPreviewUpdate = () => {
                clearTimeout(inputUpdateTimer);
                inputUpdateTimer = setTimeout(runTextareaPreviewUpdate, 400);
            };

            const cached = localStorage.getItem(IMPORT_CACHE_KEY);
            if (cached) {
                textarea.value = cached;
                updatePreview(extractUrls(cached));
            }

            textarea.addEventListener('input', () => {
                localStorage.setItem(IMPORT_CACHE_KEY, textarea.value);
                scheduleTextareaPreviewUpdate();
            });

            // 关键词筛选监听
            const includeInput = document.getElementById('includeKeywords');
            const excludeInput = document.getElementById('excludeKeywords');
            const minTextLengthInput = document.getElementById('minTextLength');
            const maxTextLengthInput = document.getElementById('maxTextLength');
            const minLikesInput = document.getElementById('minLikes');


            // 缓存键名
            const CACHE_KEYS = {
                includeKeywords: 'tweet-filter-include-keywords',
                excludeKeywords: 'tweet-filter-exclude-keywords',
                minTextLength: 'tweet-filter-min-text-length',
                maxTextLength: 'tweet-filter-max-text-length',
                minLikes: 'tweet-filter-min-likes',

                selectAll: 'tweet-filter-select-all'
            };

            // 恢复缓存的值
            const restoreCachedValues = () => {
                // 恢复文本输入
                const cachedInclude = localStorage.getItem(CACHE_KEYS.includeKeywords);
                if (cachedInclude !== null) includeInput.value = cachedInclude;

                const cachedExclude = localStorage.getItem(CACHE_KEYS.excludeKeywords);
                if (cachedExclude !== null) excludeInput.value = cachedExclude;

                const cachedMinText = localStorage.getItem(CACHE_KEYS.minTextLength);
                if (cachedMinText !== null) minTextLengthInput.value = cachedMinText;

                const cachedMaxText = localStorage.getItem(CACHE_KEYS.maxTextLength);
                if (cachedMaxText !== null) maxTextLengthInput.value = cachedMaxText;

                const cachedMinLikes = localStorage.getItem(CACHE_KEYS.minLikes);
                if (cachedMinLikes !== null) minLikesInput.value = cachedMinLikes;

                // 恢复复选框


                const cachedSelectAll = localStorage.getItem(CACHE_KEYS.selectAll);
                if (cachedSelectAll !== null) selectAll.checked = cachedSelectAll === 'true';
            };

            // 页面加载时恢复缓存
            restoreCachedValues();

            const handleFilterChange = () => {
                applyFilters();
            };

            // 添加自动保存监听器
            includeInput.addEventListener('input', () => {
                localStorage.setItem(CACHE_KEYS.includeKeywords, includeInput.value);
                handleFilterChange();
            });

            excludeInput.addEventListener('input', () => {
                localStorage.setItem(CACHE_KEYS.excludeKeywords, excludeInput.value);
                handleFilterChange();
            });

            minTextLengthInput.addEventListener('input', () => {
                localStorage.setItem(CACHE_KEYS.minTextLength, minTextLengthInput.value);
                handleFilterChange();
            });

            maxTextLengthInput.addEventListener('input', () => {
                localStorage.setItem(CACHE_KEYS.maxTextLength, maxTextLengthInput.value);
                handleFilterChange();
            });

            minLikesInput.addEventListener('input', () => {
                localStorage.setItem(CACHE_KEYS.minLikes, minLikesInput.value);
                handleFilterChange();
            });



            refreshBtn.addEventListener('click', () => {
                const hasFailedTweets = retryAllFailedTweets();
                if (hasFailedTweets) {
                    showStatus('Retrying failed tweets...', 'success');
                } else {
                    runTextareaPreviewUpdate();
                    showStatus('Preview updated', 'success');
                }
            });

            selectAll.addEventListener('change', (event) => {
                const isChecked = event.target.checked;

                // 保存 selectAll 状态到缓存
                localStorage.setItem(CACHE_KEYS.selectAll, isChecked);

                // 只操作当前模式下的复选框
                const mode = document.querySelector('input[name="previewMode"]:checked').value;
                const currentContainer = mode === 'images'
                    ? document.getElementById('linkListImages')
                    : document.getElementById('linkList');

                currentContainer.querySelectorAll('.tweet-check-input').forEach(cb => {
                    const wrapper = cb.closest('.tweet-card-wrapper') || cb.closest('.image-mode-card');
                    // 跳过隐藏的项目（被日期筛选隐藏的）
                    if (wrapper && wrapper.style.display === 'none') {
                        return;
                    }

                    cb.checked = isChecked;
                    if (wrapper) {
                        if (isChecked) {
                            wrapper.classList.remove('unchecked');
                            wrapper.classList.add('selected');
                        } else {
                            wrapper.classList.add('unchecked');
                            wrapper.classList.remove('selected');
                        }
                    }
                });
                // 统一更新计数，避免循环中多次更新导致状态错乱
                updateCounts();
            });

            copyBtn.addEventListener('click', copySelectedLinks);

            clearBtn.addEventListener('click', () => {
                textarea.value = '';
                localStorage.removeItem(IMPORT_CACHE_KEY);
                updatePreview([]);
                showStatus('Content cleared', 'success');
            });

            document.querySelectorAll('input[name="previewMode"]').forEach(radio => {
                radio.addEventListener('change', runTextareaPreviewUpdate);
            });

            // 详情按钮点击事件（使用事件委托）
            document.addEventListener('click', (e) => {
                const detailBtn = e.target.closest('.image-card-detail-btn');
                if (!detailBtn) return;

                e.preventDefault(); // 阻止默认行为，如链接跳转
                e.stopPropagation(); // 阻止事件冒泡到卡片本身的选择逻辑

                const wrapper = detailBtn.closest('.image-mode-card');
                if (!wrapper) return;

                const tweetId = detailBtn.dataset.tweetId;
                const tweetUrl = wrapper.dataset.url;
                const tweetIndex = parseInt(wrapper.dataset.index);

                let initialData = {};
                if (wrapper.dataset.tweetData) {
                    try {
                        initialData = JSON.parse(wrapper.dataset.tweetData);
                    } catch (error) {
                        console.error('Error parsing tweetData from dataset:', error);
                    }
                }

                // 获取所有图片模式卡片，用于模态框中的前后导航
                const allImageCards = Array.from(document.querySelectorAll('.image-mode-card'));

                if (tweetId && typeof openTweetDetail === 'function') {
                    openTweetDetail(initialData, tweetUrl, tweetIndex, allImageCards);
                } else {
                    console.warn('openTweetDetail function not found or tweetId missing.');
                    // 备用方案：如果模态框无法打开，尝试直接在新标签页打开推文
                    window.open(tweetUrl, '_blank');
                }

                if (detailBtn) {
                    const wrapper = detailBtn.closest('.image-mode-card');
                    if (wrapper && wrapper.dataset.tweetData) {
                        try {
                            // 获取所有可见的卡片
                            const allCards = Array.from(document.querySelectorAll('.image-mode-card'))
                                .filter(card => card.style.display !== 'none');
                            const currentIndex = allCards.indexOf(wrapper);

                            const data = JSON.parse(wrapper.dataset.tweetData);
                            const url = wrapper.querySelector('.tweet-check-input').value;
                            openTweetDetail(data, url, currentIndex, allCards);
                        } catch (err) {
                            console.error('Failed to parse tweet data:', err);
                        }
                    }
                }
            });

            // 窗口大小改变时重新布局
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    const mode = document.querySelector('input[name="previewMode"]:checked').value;
                    if (mode === 'images') {
                        applyFilters();
                    }
                }, 200);
            });
        });

        // 推文详情Modal相关函数已移至 tweet-detail-modal.js
    </script>
    <!-- Tweet Detail Modal Component Script -->
    <script src="tweet-detail-modal.js"></script>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

    <!-- Tweet Detail Modal -->
    <div class="tweet-detail-modal" id="tweetDetailModal">
        <div class="tweet-detail-main-container">
            <!-- Main Card -->
            <div class="tweet-detail-content" id="mainCard">
                <!-- Left Column: Images -->
                <div class="tweet-detail-left-col">
                    <div class="tweet-detail-images" id="modalImages"></div>
                </div>

                <!-- Right Column: Info -->
                <div class="tweet-detail-right-col">
                    <div class="tweet-detail-header">
                        <div class="tweet-detail-user">
                            <img class="tweet-detail-avatar" id="modalAvatar" src="" alt="Avatar">
                            <div class="tweet-detail-user-info">
                                <div class="tweet-detail-name" id="modalName"></div>
                                <div class="tweet-detail-username" id="modalUsername"></div>
                            </div>
                        </div>
                        <div class="tweet-detail-position" id="modalPosition">1 / 1</div>
                        <div class="tweet-detail-selected-indicator" id="modalSelectedIndicator">
                            <svg viewBox="0 0 24 24">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <button class="tweet-detail-close" onclick="closeTweetDetail()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>

                    <div class="tweet-detail-body">
                        <div class="tweet-detail-text-section">
                            <div class="tweet-detail-text" id="modalText"></div>
                            <div class="tweet-detail-time" id="modalTime"></div>
                        </div>
                    </div>

                    <div class="tweet-detail-footer">
                        <div class="tweet-detail-footer-stats">
                            <div class="tweet-detail-stat likes">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                                    </path>
                                </svg>
                                <span id="modalLikes">0</span>
                            </div>
                            <div class="tweet-detail-stat retweets">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M23.77 15.67a.749.749 0 0 0-1.06 0l-2.22 2.22V7.65a3.755 3.755 0 0 0-3.75-3.75h-5.85a.75.75 0 0 0 0 1.5h5.85c1.24 0 2.25 1.01 2.25 2.25v10.24l-2.22-2.22a.749.749 0 1 0-1.06 1.06l3.5 3.5a.747.747 0 0 0 1.06 0l3.5-3.5a.749.749 0 0 0 0-1.06zm-10.66 3.28H7.26c-1.24 0-2.25-1.01-2.25-2.25V6.46l2.22 2.22a.752.752 0 0 0 1.062 0 .749.749 0 0 0 0-1.06l-3.5-3.5a.747.747 0 0 0-1.06 0l-3.5 3.5a.749.749 0 1 0 1.06 1.06l2.22-2.22V16.7a3.755 3.755 0 0 0 3.75 3.75h5.85a.75.75 0 0 0 0-1.5z">
                                    </path>
                                </svg>
                                <span id="modalRetweets">0</span>
                            </div>
                            <div class="tweet-detail-stat replies">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z">
                                    </path>
                                </svg>
                                <span id="modalReplies">0</span>
                            </div>
                        </div>
                        <div class="tweet-detail-footer-actions">
                            <button class="tweet-detail-action-btn" id="modalCopyBtn" title="Copy Link">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                            <a class="tweet-detail-action-btn" id="modalUnimageBtn" target="_blank" rel="noopener">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                Unimage
                            </a>
                            <a class="tweet-detail-action-btn" id="modalOpenBtn" target="_blank" rel="noopener">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path
                                        d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3">
                                    </path>
                                </svg>
                                X
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="thumbnail-strip" id="thumbnailStrip"></div>
        </div>
    </div>
</body>

</html>