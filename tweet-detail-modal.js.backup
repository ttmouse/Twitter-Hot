/**
 * Tweet Detail Modal Component
 * Reusable modal component with keyboard navigation and thumbnail preview
 */

// Modal navigation global variables - attached to window to avoid redeclaration on reload
window.currentModalIndex = window.currentModalIndex ?? -1;
window.visibleCards = window.visibleCards ?? [];
window.modalKeyboardHandler = window.modalKeyboardHandler ?? null;

/**
 * Open Tweet Detail Modal
 * @param {Object} data - Tweet data
 * @param {string} url - Tweet URL
 * @param {number} index - Current card index
 * @param {Array} cards - All visible cards array
 */
function openTweetDetail(data, url, index, cards) {
    console.log('[Modal] openTweetDetail called, index:', index, 'cards:', cards.length);
    const modal = document.getElementById('tweetDetailModal');

    if (!modal) {
        console.error('[Modal] Modal element not found!');
        return;
    }

    // Save current state
    window.currentModalIndex = index;
    window.visibleCards = cards;
 * @param {string} url - Tweet URL
 * @param {number} index - Current card index
 * @param {Array} cards - All visible cards array
 */
function openTweetDetail(data, url, index, cards) {
    console.log('[Modal] openTweetDetail called, index:', index, 'cards:', cards.length);
    const modal = document.getElementById('tweetDetailModal');

    if (!modal) {
        console.error('[Modal] Modal element not found!');
        return;
    }

    // Save current state
    currentModalIndex = index;
    visibleCards = cards;

    // Generate all thumbnails
    generateThumbnails();

    // Update main card content
    updateMainCard(currentModalIndex);

    // Show Modal
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    console.log('[Modal] Modal displayed');

    // Remove old keyboard event listener
    if (modalKeyboardHandler) {
        document.removeEventListener('keydown', modalKeyboardHandler);
    }

    // Add keyboard event listener
    modalKeyboardHandler = (e) => {
        // Ignore keypresses in input fields
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
        }

        switch(e.key) {
            case 'Escape':
                closeTweetDetail();
                break;
            case ' ':
                e.preventDefault();
                toggleCurrentTweetSelection();
                break;
            case 'ArrowUp':
                e.preventDefault();
                scrollModalContent(-100);
                break;
            case 'ArrowDown':
                e.preventDefault();
                scrollModalContent(100);
                break;
            case 'ArrowLeft':
                e.preventDefault();
                navigateToTweet(-1);
                break;
            case 'ArrowRight':
                e.preventDefault();
                navigateToTweet(1);
                break;
            case 'c':
            case 'C':
                e.preventDefault();
                copyCurrentTweetLink();
                break;
            case 'Enter':
                e.preventDefault();
                openCurrentTweet();
                break;
        }
    };

    document.addEventListener('keydown', modalKeyboardHandler);

    // Click background to close - using one-time event listener to avoid accumulation
    const handleModalClick = (e) => {
        if (e.target === modal) {
            closeTweetDetail();
        }
    };

    // Remove old listener (if exists)
    if (modal._clickHandler) {
        modal.removeEventListener('click', modal._clickHandler);
    }
    modal._clickHandler = handleModalClick;
    modal.addEventListener('click', handleModalClick);

    // Main card doesn't trigger close
    const mainCard = document.getElementById('mainCard');
    const handleMainCardClick = (e) => {
        e.stopPropagation();
    };

    if (mainCard._clickHandler) {
        mainCard.removeEventListener('click', mainCard._clickHandler);
    }
    mainCard._clickHandler = handleMainCardClick;
    mainCard.addEventListener('click', handleMainCardClick);

    // Selected indicator click event
    const indicator = document.getElementById('modalSelectedIndicator');
    const handleIndicatorClick = (e) => {
        e.stopPropagation();
        toggleCurrentTweetSelection();
    };

    if (indicator._clickHandler) {
        indicator.removeEventListener('click', indicator._clickHandler);
    }
    indicator._clickHandler = handleIndicatorClick;
    indicator.addEventListener('click', handleIndicatorClick);

    console.log('[Modal] All event listeners attached');
}

/**
 * Generate all thumbnails
 */
function generateThumbnails() {
    const thumbnailStrip = document.getElementById('thumbnailStrip');
    thumbnailStrip.innerHTML = '';

    visibleCards.forEach((card, index) => {
        if (!card || !card.dataset.tweetData) return;

        try {
            const cardData = JSON.parse(card.dataset.tweetData);
            const checkbox = card.querySelector('.tweet-check-input');
            const isSelected = checkbox && checkbox.checked;
            const isCurrent = index === currentModalIndex;

            // Create thumbnail element
            const thumbnailItem = document.createElement('div');
            thumbnailItem.className = `thumbnail-item${isCurrent ? ' active' : ''}${!isSelected ? ' unselected' : ''}`;
            thumbnailItem.dataset.index = index;

            // Get first image as thumbnail
            let thumbnailContent = '';
            if (cardData.media_extended && cardData.media_extended.length > 0) {
                const firstMedia = cardData.media_extended[0];
                if (firstMedia.type === 'image') {
                    thumbnailContent = `<img src="${firstMedia.url}" alt="Tweet thumbnail">`;
                } else if (firstMedia.type === 'video' && firstMedia.thumbnail_url) {
                    thumbnailContent = `<img src="${firstMedia.thumbnail_url}" alt="Video thumbnail">`;
                } else {
                    thumbnailContent = `<div class="thumbnail-item-placeholder">Video</div>`;
                }
            } else if (cardData.mediaURLs && cardData.mediaURLs.length > 0) {
                thumbnailContent = `<img src="${cardData.mediaURLs[0]}" alt="Tweet thumbnail">`;
            } else {
                // No images, show text preview
                const textPreview = (cardData.text || 'No content').substring(0, 20);
                thumbnailContent = `<div class="thumbnail-item-placeholder">${textPreview}</div>`;
            }

            thumbnailItem.innerHTML = `
                ${thumbnailContent}
                <div class="thumbnail-item-number">${index + 1}</div>
                ${isSelected ? `<div class="thumbnail-item-selected">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>` : ''}
            `;

            // Click thumbnail to switch
            thumbnailItem.addEventListener('click', () => {
                navigateToIndex(index);
            });

            thumbnailStrip.appendChild(thumbnailItem);
        } catch (err) {
            console.error('Failed to generate thumbnail:', err);
        }
    });

    // Scroll to current thumbnail
    scrollToActiveThumbnail();
}

/**
 * Scroll to the currently active thumbnail
 */
function scrollToActiveThumbnail() {
    const thumbnailStrip = document.getElementById('thumbnailStrip');
    const activeThumbnail = thumbnailStrip.querySelector('.thumbnail-item.active');

    if (activeThumbnail) {
        activeThumbnail.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest',
            inline: 'center'
        });
    }
}

/**
 * Scroll modal card content
 * @param {number} delta - Scroll distance (positive for down, negative for up)
 */
function scrollModalContent(delta) {
    const modalBody = document.querySelector('.tweet-detail-body');
    if (modalBody) {
        modalBody.scrollBy({
            top: delta,
            behavior: 'smooth'
        });
    }
}

/**
 * Navigate to specified index
 * @param {number} index - Target index
 */
function navigateToIndex(index) {
    if (index < 0 || index >= visibleCards.length || index === currentModalIndex) {
        return;
    }

    currentModalIndex = index;

    // Update thumbnail active state
    const thumbnails = document.querySelectorAll('.thumbnail-item');
    thumbnails.forEach((thumb, i) => {
        if (i === index) {
            thumb.classList.add('active');
        } else {
            thumb.classList.remove('active');
        }
    });

    // Scroll to current thumbnail
    scrollToActiveThumbnail();

    // Update main card
    updateMainCard(index);
}

/**
 * Update main card content
 * @param {number} index - Card index
 */
function updateMainCard(index) {
    const card = visibleCards[index];
    if (!card || !card.dataset.tweetData) return;

    try {
        const cardData = JSON.parse(card.dataset.tweetData);
        const cardUrl = card.querySelector('.tweet-check-input').value;
        const checkbox = card.querySelector('.tweet-check-input');
        const isSelected = checkbox && checkbox.checked;

        // Update main card selection state style
        const mainCard = document.getElementById('mainCard');
        if (isSelected) {
            mainCard.classList.remove('unselected');
        } else {
            mainCard.classList.add('unselected');
        }

        // Fill user info
        document.getElementById('modalAvatar').src = cardData.user_profile_image_url || '';
        document.getElementById('modalName').textContent = cardData.user_name || 'Unknown';
        document.getElementById('modalUsername').textContent = `@${cardData.user_screen_name || 'unknown'}`;

        // Update position indicator
        document.getElementById('modalPosition').textContent = `${index + 1} / ${visibleCards.length}`;

        // Update selection state
        const indicator = document.getElementById('modalSelectedIndicator');
        if (checkbox && checkbox.checked) {
            indicator.classList.add('selected');
        } else {
            indicator.classList.remove('selected');
        }

        // Fill tweet text
        document.getElementById('modalText').textContent = cardData.text || '';

        // Fill media (full version)
        const imagesContainer = document.getElementById('modalImages');
        imagesContainer.innerHTML = '';
        if (cardData.media_extended && cardData.media_extended.length > 0) {
            const mediaItems = cardData.media_extended.filter(m => m.type === 'image' || m.type === 'video');
            if (mediaItems.length > 0) {
                imagesContainer.className = 'tweet-detail-images';

                // Add all media elements first
                const mediaElements = [];
                mediaItems.forEach(item => {
                    if (item.type === 'image') {
                        const imgEl = document.createElement('img');
                        imgEl.src = item.url;
                        imgEl.alt = 'Tweet image';
                        mediaElements.push(imgEl);
                        imagesContainer.appendChild(imgEl);
                    } else if (item.type === 'video') {
                        const videoEl = document.createElement('video');
                        videoEl.controls = true;
                        videoEl.preload = 'metadata';
                        videoEl.style.width = '100%';
                        videoEl.style.height = 'auto';
                        videoEl.style.display = 'block';
                        videoEl.style.backgroundColor = '#000';
                        videoEl.tabIndex = -1;
                        if (item.thumbnail_url) {
                            videoEl.poster = item.thumbnail_url;
                        }
                        if (item.url) {
                            videoEl.src = item.url;
                        }
                        // Prevent video's default keyboard behavior
                        videoEl.addEventListener('keydown', (e) => {
                            if (['ArrowLeft', 'ArrowRight', ' ', 'Enter'].includes(e.key)) {
                                e.preventDefault();
                            }
                        });
                        mediaElements.push(videoEl);
                        imagesContainer.appendChild(videoEl);
                    }
                });

                // Check image height and decide layout
                if (mediaElements.length === 1) {
                    imagesContainer.classList.add('single');
                } else {
                    // Wait for the first image to load, check height
                    const firstImg = mediaElements[0];
                    if (firstImg.tagName === 'IMG') {
                        firstImg.onload = () => {
                            const imageHeight = firstImg.naturalHeight;
                            const imageWidth = firstImg.naturalWidth;
                            const aspectRatio = imageHeight / imageWidth;

                            // If landscape (width > height) or small height, use single column
                            if (aspectRatio < 0.8) {
                                imagesContainer.classList.add('single');
                            } else if (mediaElements.length === 2) {
                                imagesContainer.classList.add('double');
                            } else {
                                imagesContainer.classList.add('multiple');
                            }
                        };
                        // If image already loaded, execute immediately
                        if (firstImg.complete) {
                            const imageHeight = firstImg.naturalHeight;
                            const imageWidth = firstImg.naturalWidth;
                            const aspectRatio = imageHeight / imageWidth;

                            if (aspectRatio < 0.8) {
                                imagesContainer.classList.add('single');
                            } else if (mediaElements.length === 2) {
                                imagesContainer.classList.add('double');
                            } else {
                                imagesContainer.classList.add('multiple');
                            }
                        }
                    } else {
                        // Video defaults to original logic
                        if (mediaElements.length === 2) {
                            imagesContainer.classList.add('double');
                        } else {
                            imagesContainer.classList.add('multiple');
                        }
                    }
                }
            }
        } else if (cardData.mediaURLs && cardData.mediaURLs.length > 0) {
            imagesContainer.className = 'tweet-detail-images';
            const imgElements = [];
            cardData.mediaURLs.forEach(imgUrl => {
                const imgEl = document.createElement('img');
                imgEl.src = imgUrl;
                imgEl.alt = 'Tweet image';
                imgElements.push(imgEl);
                imagesContainer.appendChild(imgEl);
            });

            // Detect layout
            if (imgElements.length === 1) {
                imagesContainer.classList.add('single');
            } else {
                const firstImg = imgElements[0];
                firstImg.onload = () => {
                    const aspectRatio = firstImg.naturalHeight / firstImg.naturalWidth;
                    if (aspectRatio < 0.8) {
                        imagesContainer.classList.add('single');
                    } else if (imgElements.length === 2) {
                        imagesContainer.classList.add('double');
                    } else {
                        imagesContainer.classList.add('multiple');
                    }
                };
                if (firstImg.complete) {
                    const aspectRatio = firstImg.naturalHeight / firstImg.naturalWidth;
                    if (aspectRatio < 0.8) {
                        imagesContainer.classList.add('single');
                    } else if (imgElements.length === 2) {
                        imagesContainer.classList.add('double');
                    } else {
                        imagesContainer.classList.add('multiple');
                    }
                }
            }
        }

        // Fill interaction data
        document.getElementById('modalLikes').textContent = cardData.likes || 0;
        document.getElementById('modalRetweets').textContent = cardData.retweets || 0;
        document.getElementById('modalReplies').textContent = cardData.replies || 0;

        // Fill time
        if (cardData.date) {
            const date = new Date(cardData.date);
            const timeStr = date.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('modalTime').textContent = timeStr;
        }

        // Set action buttons
        document.getElementById('modalOpenBtn').href = cardUrl;
        document.getElementById('modalCopyBtn').onclick = async () => {
            try {
                await navigator.clipboard.writeText(cardUrl);
                const btn = document.getElementById('modalCopyBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                console.error('Copy failed:', err);
            }
        };
    } catch (err) {
        console.error('Failed to update main card:', err);
    }
}

/**
 * Navigate to previous/next tweet
 * @param {number} direction - Direction (-1 for previous, 1 for next)
 */
async function navigateToTweet(direction) {
    const newIndex = currentModalIndex + direction;

    // Check boundaries
    if (newIndex < 0) {
        console.log('[Modal Navigation] Already at first card');
        return;
    }

    if (newIndex >= visibleCards.length) {
        // Reached end, try to load next date
        console.log('[Modal Navigation] Reached end, trying to load next date...');

        // Check if loadNextDateForModal is available
        if (typeof window.loadNextDateForModal !== 'function') {
            console.log('[Modal Navigation] loadNextDateForModal not available');
            return;
        }

        try {
            // Load next date and get new cards
            const allCards = await window.loadNextDateForModal();
            console.log('[Modal Navigation] Got', allCards.length, 'cards after loading');

            if (allCards.length > visibleCards.length) {
                // Update visible cards with the full set including newly loaded ones
                visibleCards = allCards;
                console.log('[Modal Navigation] Updated visibleCards to', visibleCards.length, 'cards');

                // Regenerate all thumbnails with new cards
                generateThumbnails();

                // Navigate to the first card of the newly loaded content
                navigateToIndex(newIndex);
            } else {
                console.log('[Modal Navigation] No new cards loaded');
            }
        } catch (error) {
            console.log('[Modal Navigation] Failed to load next date:', error.message);
            // Optionally show a toast message to the user
            // showToast('Already at the last day\'s content');
        }
        return;
    }

    navigateToIndex(newIndex);
}

/**
 * Toggle current tweet selection status
 * Requires external toggleItemStyle function
 */
function toggleCurrentTweetSelection() {
    const currentCard = visibleCards[currentModalIndex];
    if (!currentCard) return;

    const checkbox = currentCard.querySelector('.tweet-check-input');
    if (!checkbox) return;

    checkbox.checked = !checkbox.checked;

    // Call external toggleItemStyle function (if exists)
    if (typeof toggleItemStyle === 'function') {
        toggleItemStyle(checkbox);
    }

    // Update selection status indicator in modal
    const indicator = document.getElementById('modalSelectedIndicator');
    if (checkbox.checked) {
        indicator.classList.add('selected');
    } else {
        indicator.classList.remove('selected');
    }

    // Update main card gray effect
    const mainCard = document.getElementById('mainCard');
    if (checkbox.checked) {
        mainCard.classList.remove('unselected');
    } else {
        mainCard.classList.add('unselected');
    }

    // Update selection mark and gray effect on thumbnail
    const thumbnailItem = document.querySelector(`.thumbnail-item[data-index="${currentModalIndex}"]`);
    if (thumbnailItem) {
        if (checkbox.checked) {
            // Remove gray effect
            thumbnailItem.classList.remove('unselected');
            // Add selection mark
            if (!thumbnailItem.querySelector('.thumbnail-item-selected')) {
                const selectedMark = document.createElement('div');
                selectedMark.className = 'thumbnail-item-selected';
                selectedMark.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                `;
                thumbnailItem.appendChild(selectedMark);
            }
        } else {
            // Add gray effect
            thumbnailItem.classList.add('unselected');
            // Remove selection mark
            const selectedMark = thumbnailItem.querySelector('.thumbnail-item-selected');
            if (selectedMark) {
                selectedMark.remove();
            }
        }
    }
}

/**
 * Copy current tweet link
 */
async function copyCurrentTweetLink() {
    const currentCard = visibleCards[currentModalIndex];
    if (!currentCard) return;

    const checkbox = currentCard.querySelector('.tweet-check-input');
    if (!checkbox) return;

    const url = checkbox.value;

    try {
        await navigator.clipboard.writeText(url);

        // Show temporary toast in modal
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--accent);
            color: var(--accent-foreground);
            padding: 1rem 2rem;
            border-radius: 8px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.9rem;
            z-index: 10000;
            box-shadow: var(--shadow-accent);
            animation: fadeIn 0.2s ease;
        `;
        toast.textContent = 'âœ“ Link copied';
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 1500);
    } catch (err) {
        console.error('Copy failed:', err);
    }
}

/**
 * Open current tweet
 */
function openCurrentTweet() {
    const currentCard = visibleCards[currentModalIndex];
    if (!currentCard) return;

    const checkbox = currentCard.querySelector('.tweet-check-input');
    if (!checkbox) return;

    const url = checkbox.value;
    window.open(url, '_blank', 'noopener');
}

/**
 * Close tweet detail modal
 */
function closeTweetDetail() {
    console.log('[Modal] closeTweetDetail called');
    const modal = document.getElementById('tweetDetailModal');

    if (!modal) {
        console.error('[Modal] Modal element not found when closing!');
        return;
    }

    modal.classList.remove('show');
    document.body.style.overflow = '';

    // Remove keyboard event listener
    if (modalKeyboardHandler) {
        document.removeEventListener('keydown', modalKeyboardHandler);
        modalKeyboardHandler = null;
    }

    // Clean up click event listeners
    if (modal._clickHandler) {
        modal.removeEventListener('click', modal._clickHandler);
        modal._clickHandler = null;
    }

    const mainCard = document.getElementById('mainCard');
    if (mainCard && mainCard._clickHandler) {
        mainCard.removeEventListener('click', mainCard._clickHandler);
        mainCard._clickHandler = null;
    }

    const indicator = document.getElementById('modalSelectedIndicator');
    if (indicator && indicator._clickHandler) {
        indicator.removeEventListener('click', indicator._clickHandler);
        indicator._clickHandler = null;
    }

    // Clean up state
    currentModalIndex = -1;
    visibleCards = [];

    console.log('[Modal] Modal closed and cleaned up');
}
